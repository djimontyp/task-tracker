# Посібник з усування неполадок

**Останнє оновлення:** 27 жовтня 2025
**Статус:** Повний посібник
**Аудиторія:** Користувачі, що мають проблеми з автоматизацією

## Поширені проблеми та рішення

### Проблема 1: Завдання не запускається

**Симптоми:**
- Час наступного запуску проходить без виконання
- Панель приладів показує "Останній запуск: Ніколи"
- Статус залишається "Неактивний"
- Новi версії не автоматично затверджуються

**Основні причини:**
1. Завдання вимкнено
2. Сервіс планувальника не в мережі
3. Невалідний вираз cron
4. Помилка підключення до бази даних
5. Черга worker не обробляє

#### Рішення крок за кроком

**Крок 1: Перевірте, чи автоматизація ввімкнена**

1. Перейдіть до **Параметри → Автоматизація**
2. Шукайте перемикач з позначкою "Увімкнути автоматизацію"
3. Якщо перемикач ВИМКНЕНО, клацніть, щоб увімкнути
4. Перевірте поле "Наступний запуск" оновляється

**Очікуване:** Перемикач показує ВЛ, час наступного запуску показує "Завтра 9:00"

**Крок 2: Переконайтеся, що служба планувальника запущена**

Відкрийте термінал/командний рядок і перевірте:

```bash
docker ps | grep worker
```

**Очікуваний висновок:**
```
abc1234def56 task-tracker-worker ... Up 2 days
```

**Якщо не запущено:**
- Попросіть адміна перезапустити: `docker compose restart worker`
- Перевірте журнали: `docker logs task-tracker-worker`

**Крок 3: Валідуйте Cron вираз**

Якщо використовуєте користувальницький cron:

1. Перейдіть до **Параметри → Автоматизація**
2. Скопіюйте вираз cron (наприклад, `0 9 * * *`)
3. Використовуйте онлайн-валідатор: https://crontab.guru
4. Повинен показати зрозумілий людям опис
5. Якщо помилка з'явиться, виправте синтаксис

**Звичайні помилки:**
- `60 * * * *` - Невалідна (година поза межами)
- `0 25 * * *` - Невалідна (хвилина поза межами)
- `0 9 32 * *` - Невалідна (дня 32 не існує)

**Крок 4: Перевірте підключення до бази даних**

Виконайте цю команду:

```bash
docker exec task-tracker-api psql -U postgres -d tasktracker -c "SELECT COUNT(*) FROM approval_rules;"
```

Повинен повернути число (кількість правил).

**Крок 5: Протестуйте ручне запуск**

1. Перейдіть до **Параметри → Автоматизація**
2. Шукайте кнопку "Запустити зараз"
3. Клацніть на неї
4. Перевірте повідомлення про успіх чи помилку

---

### Проблема 2: Авто-затвердження не працює

**Симптоми:**
- Версії створені, але не автоматично затверджені
- Кількість очікування збільшується, ніякі не затверджені
- Ручна перевірка потрібна для всіх версій
- Правило, здається, включено, але не спрацьовує

**Основні причини:**
1. Умови правила занадто суворі
2. Правило вимкнено або неактивне
3. Дані версії відсутні впевненість/схожість оцінки
4. База даних не зберігає конфігурацію правила

#### Рішення крок за кроком

**Крок 1: Перевірте, чи правило активне**

1. Перейдіть до **Параметри → Автоматизація → Правила**
2. Знайдіть своє правило (наприклад, "Авто-затвердження високої впевненості")
3. Перевірте перемикач показує "Увімкнено"
4. Якщо вимкнено, клацніть, щоб увімкнути

**Крок 2: Переглядайте умови правила**

1. Клацніть на назву правила для редагування
2. Перевірте поточні пороги
3. Порівняйте з незавершеними версіями:
   - Перейдіть до **Панель приладів → Незавершені версії**
   - Клацніть на версію для перегляду показників впевненості/схожості
   - Це відповідає умовам правила?

**Приклад:**
- Правило вимагає: впевненість >= 90 І схожість >= 85
- Незавершена версія показує: впевненість 75, схожість 80
- **Результат:** Версія не відповідає умовам → залишається очікуючою

**Крок 3: Виконайте попередній перегляд**

1. Перейдіть до **Параметри → Автоматизація → Правила**
2. Клацніть кнопку "Попередній перегляд"
3. Показує: "Це правило вплине на X версій"
4. Якщо попередній перегляд показує 0, умови занадто суворі

**Дія:** Знизьте пороги та повторіть попередній перегляд

**Крок 4: Протестуйте правило вручну**

1. Створіть тестову версію
2. Встановіть впевненість = 95, схожість = 95
3. Дочекайтеся наступного запланованого запуску
4. Перевірте, чи вона буде затверджена

---

### Проблема 3: Сповіщення не отримані

**Симптоми:**
- Листи не приходять
- Повідомлення Telegram не отримані
- Оновлення значка в додатку (тому автоматизація працює)
- Немає сповіщень для незавершених версій

**Основні причини:**
1. Канал електронної пошти/Telegram вимкнено
2. Невалідна адреса електронної пошти або ID чату Telegram
3. Поріг сповіщення не досягнув
4. Неправильна конфігурація SMTP або бота

#### Рішення крок за кроком

**Крок 1: Перевірте переваги сповіщень**

1. Перейдіть до **Параметри → Автоматизація → Сповіщення**
2. Перевірте розділ електронної пошти:
   - Перемикач показує "Увімкнено"
   - Адреса електронної пошти правильна
3. Перевірте розділ Telegram:
   - Перемикач показує "Увімкнено"
   - Токен бота, здається, дійсний

**Якщо вимкнено, увімкніть** і протестуйте знову.

**Крок 2: Протестуйте сповіщення електронною поштою**

1. Перейдіть до **Параметри → Автоматизація → Сповіщення**
2. Знайдіть розділ електронної пошти
3. Клацніть "Надіслати тестовий лист"
4. Перевірте вхідний для тестового листа

**Очікуване:** Лист приходить протягом 30 секунд

**Крок 3: Протестуйте сповіщення Telegram**

1. Перейдіть до **Параметри → Автоматизація → Сповіщення**
2. Знайдіть розділ Telegram
3. Клацніть "Надіслати тестове повідомлення"
4. Перевірте Telegram для повідомлення

**Очікуване:** Повідомлення Telegram з'явиться протягом 10 секунд

---

### Проблема 4: Високий рівень помилок позитивних

**Симптоми:**
- Багато авто-затверджених версій невірні
- Неправильні назви, описи або зміни метаданих
- Ручна перевірка знаходить 20%+ неправильні
- Якість погіршується з часом

**Основні причини:**
1. Пороги занадто низькі
2. Правила занадто широкі або відсутні умови
3. Неправильна оцінка впевненості/схожості
4. Логіка правила неправильна (АБО замість І)

#### Рішення крок за кроком

**Крок 1: Виміряйте рівень помилок позитивних**

1. Перейдіть до **Панель приладів → Статистика автоматизації**
2. Зверніть увагу на кількість "Авто-затверджено" сьогодні (наприклад, 34)
3. Перейдіть до **Версії → Історія** або **Журнал аудиту**
4. Вручну перевірте 20-30 затверджених версій
5. Порахуйте, скільки насправді неправильні
6. Обчисліть: (неправильна кількість / перевірено загалом) × 100

**Приклад:**
- Перевірено 30 версій
- Знайдено 5 неправильні
- Рівень помилок = 5/30 = 17%

**Прийнятно:** <10% рівень помилок позитивних

**Крок 2: Порівняйте з порогами**

1. Перейдіть до **Параметри → Автоматизація → Правила**
2. Зверніть увагу на поточні пороги (наприклад, впевненість 75%, схожість 65%)
3. Перевірте: Вони нижче рекомендованих?

**Рекомендовані стартові точки:**
- Консервативна: 90/85
- Збалансована: 80/70
- Агресивна: 70/60

**Крок 3: Змініть пороги**

1. Перейдіть до **Параметри → Автоматизація → Правила**
2. Клацніть своє правило для редагування
3. Збільшіть обидва пороги на 5-10%
4. Клацніть "Попередній перегляд" для перегляду впливу
5. Якщо попередній перегляд показує менше затверджених версій, збережіть

---

### Проблема 5: Кількість очікуючих версій не оновлюється

**Симптоми:**
- Badge показує 23 очікуючих, ніколи не змінюється
- Після ручного затвердження знову зростає
- WebSocket не оновлює лічильник
- Після оновлення сторінки кількість інша

**Основні причини:**
1. Втрачено WebSocket з'єднання
2. Кеш badge не оновлюється
3. Застарілі дані в браузері
4. Проблеми синхронізації бази даних

#### Покрокове рішення

**Крок 1: Оновіти сторінку**

Іноді кеш браузера застарілий:

1. Натисніть **F5** або **Cmd+R** для оновлення
2. Зачекайте 5 секунд для повного завантаження
3. Перевірте, чи оновився лічильник

**Крок 2: Перевірити WebSocket з'єднання**

1. Відкрийте інструменти розробника (F12)
2. Перейдіть на вкладку **Network**
3. Фільтруйте за "WS" (WebSocket)
4. Має бути з'єднання до `ws://localhost/...`
5. Статус має показувати "101 Web Socket Protocol Handshake"

**Якщо з'єднання показує ERROR або CLOSED:**
- Закрийте та знову відкрийте панель приладів
- Перевірте, чи працює мережа
- Попросіть адміна перевірити сервіс WebSocket

**Крок 3: Жорстке оновлення (очистити кеш)**

Застарілі JavaScript/CSS можуть викликати застарілі лічильники. Примусове перезавантаження:

1. **Chrome/Firefox/Edge:**
   - Натисніть **Ctrl + Shift + R** (Windows/Linux)
   - Натисніть **Cmd + Shift + R** (Mac)

2. **Або через DevTools:**
   - Відкрийте DevTools (F12)
   - Клацніть правою кнопкою миші на кнопку оновлення
   - Виберіть "Очистити кеш та жорстке перезавантаження"

3. **Перевірте:**
   - Зачекайте повного завантаження сторінки
   - Перевірте, чи оновився badge
   - Перевірте консоль браузера на помилки (F12 → Console)

**Очікується:** Лічильник відповідає останньому стану бази даних після жорсткого оновлення.

---

### Проблема 6: 404 помилки або "Not Found" відповіді

**Симптоми:**
- API запити падають з 404 статусом
- Консоль браузера показує "GET /api/v1/... 404"
- Функції не завантажуються або показують помилки
- Після нещодавнього оновлення або деплою

**Основні причини:**
1. Змінився шлях API маршруту (напр., `/topics/{id}/versions` → `/versions/topics/{id}/versions`)
2. Застарілий JavaScript в кеші браузера
3. Невідповідність версій frontend/backend
4. Неправильно налаштований Nginx

#### Покрокове рішення

**Крок 1: Жорстке оновлення браузера**

Більшість 404 після оновлень викликані закешованим JavaScript, що викликає старі endpoints:

1. **Жорстке оновлення:**
   - **Ctrl + Shift + R** (Windows/Linux)
   - **Cmd + Shift + R** (Mac)

2. **Або очистити кеш вручну:**
   - F12 → Application → Clear storage → Clear site data
   - Закрити та знову відкрити браузер

3. **Перевірте:**
   - Перевірте вкладку Network (F12 → Network)
   - Шукайте 200 OK відповіді замість 404

**Очікується:** Після жорсткого оновлення всі API виклики мають повертати 200 або відповідний статус.

**Крок 2: Перевірити версію API**

Переконайтеся, що frontend викликає правильні API endpoints:

1. Відкрийте DevTools браузера (F12)
2. Перейдіть на вкладку **Network**
3. Фільтруйте за "Fetch/XHR"
4. Шукайте API виклики (напр., `/api/v1/automation/stats`)
5. Перевірте, чи URL запиту відповідає поточним backend маршрутам

**Зміни шляхів у Phase 2:**
- ~~`/topics/{id}/versions`~~ → `/versions/topics/{id}/versions`
- ~~`/atoms/{id}/versions`~~ → `/versions/atoms/{id}/versions`
- Нові: `/versions/pending-count`
- Нові: `/versions/bulk-approve`

**Крок 3: Перевірити маршрути Backend**

Перевірте, чи backend працює з останнім кодом:

```bash
docker logs task-tracker-api | grep "Application startup complete"
```

**Очікуваний вивід:**
```
INFO: Application startup complete.
INFO: Uvicorn running on http://0.0.0.0:8000
```

**Якщо з'являються старі маршрути в логах:**
- Backend потребує перебудови: `docker compose build api`
- Перезапустіть сервіс: `docker compose restart api`

**Крок 4: Перевірити конфігурацію Nginx**

Якщо API доступний безпосередньо, але не через Nginx:

```bash
docker logs task-tracker-nginx | grep -i error
```

**Шукайте:**
- `upstream not found` → Nginx не може досягти API
- `no live upstreams` → API контейнер не працює

**Виправлення:**
- Перезапустіть Nginx: `docker compose restart nginx`
- Перебудуйте при необхідності: `docker compose build nginx`

---

## Кроки Налагодження (Систематичний підхід)

Використовуйте цей контрольний список при усуненні неполадок автоматизації:

**Етап 1: Базові перевірки (2 хвилини)**
- [ ] Автоматизація увімкнена? (Параметри → Автоматизація)
- [ ] Час наступного запуску в майбутньому? (не в минулому)
- [ ] Поточний час збігається з часовим поясом? (час сервера проти місцевого)
- [ ] Сторінка недавно оновлена? (F5)

**Етап 2: Здоров'я служби (3 хвилини)**
- [ ] Служба worker запущена? (`docker ps | grep worker`)
- [ ] База даних запущена? (`docker ps | grep postgres`)
- [ ] API запущена? (`docker ps | grep api`)
- [ ] Жодна служба не показує "Вихідна"?

**Етап 3: Перевірка конфігурації (5 хвилин)**
- [ ] Правило увімкнено?
- [ ] Умови правила відповідають незавершеним версіям?
- [ ] Вираз cron дійсний? (перевірте crontab.guru)
- [ ] Сповіщення ввімкнені? (якщо очікуєте оповіщень)

**Етап 4: Тестування (3 хвилини)**
- [ ] Запустити автоматизацію зараз? (клацніть кнопку "Запустити зараз")
- [ ] Протестувати електронну пошту? (клацніть "Надіслати тестовий лист")
- [ ] Протестувати Telegram? (клацніть "Надіслати тестове повідомлення")
- [ ] Перевірити результат?

**Етап 5: Дослідження журналів (5 хвилин)**
- [ ] Перевірити журнали worker? (`docker logs task-tracker-worker`)
- [ ] Шукати помилку або виключення?
- [ ] Перевірити журнали бази даних?

## Довідник повідомлень про помилки

| Помилка | Причина | Виправлення |
|---------|--------|-----------|
| "Невалідний вираз cron" | Помилка синтаксису в cron | Використовуйте https://crontab.guru для валідації |
| "Завдання не знайдено" | Планувальник не має запису завдання | Перезапустіть сервіс worker |
| "Помилка аутентифікації SMTP" | Неправильна конфігурація електронної пошти | Попросіть адміна перевірити облікові дані SMTP |
| "Бот Telegram не знайдено" | Невалідний токен бота | Перевірте токен у параметрах |
| "Помилка оцінювання правила" | Помилка в умовах правила | Перевірте синтаксис правила, видаліть проблемні умови |
| "Відмова підключення до бази даних" | PostgreSQL не в мережі | Попросіть адміна перезапустити postgres |
| "WebSocket від'єднано" | Проблема мережі або сервер вимкнено | Оновіть сторінку, перевірте з'єднання з інтернетом |
| "Версія не знайдена" | Версія видалена після створення | Можливо, умова гонитви, повторіть спробу |
| "404 Not Found" | Застарілий кеш або змінені API маршрути | Жорстке оновлення браузера (Ctrl+Shift+R) |

## Отримання довідки

**Самообслуговування:**
- Перевірте цей посібник з усування неполадок для вашого симптому
- Перегляньте конфігурацію з [Довідник конфігурації](automation-configuration.md)
- Прочитайте [Найкращі практики](automation-best-practices.md)

**Попросіть свого адміна:**
- "Завдання не запускається" → Перевірте сервіс планувальника
- "Помилка підключення до бази даних" → Перевірте сервіс postgres
- "SMTP/Telegram не працює" → Перевірте облікові дані

---

**Все ще мають проблеми?** Див. [Посібник найкращих практик](automation-best-practices.md) для рекомендованих конфігурацій, які мінімізують проблеми.
