# Управління завданнями

**Останнє оновлення:** 26 жовтня 2025
**Статус:** Повний
**Аудиторія:** Системні адміністратори

## Архітектура APScheduler

Task Tracker використовує APScheduler (Advanced Python Scheduler) як планувальник фонових завдань.

### Архітектура

```
┌─────────────┐
│  База даних │  PostgreSQL сховище завдань
│  (apscheduler_jobs)
└──────┬──────┘
       │
       ↓
┌─────────────┐
│ APScheduler │  Планувальник у пам'яті
│   Daemon    │  Виконує запланованим завданнями
└──────┬──────┘
       │
       ↓
┌─────────────┐
│  Worker     │  FastAPI Celery/TaskIQ worker
│  Process    │  Обробляє правила автоматизації
└─────────────┘
```

### Стани завдань

```
PENDING      → Очікування планування
SCHEDULED    → В розкладі, очікування часу
EXECUTING    → Виконується
COMPLETED    → Закінчено успішно
FAILED       → Помилка під час виконання
PAUSED       → Вручну припинено адміном
REMOVED      → Видалено з розкладу
```

## Запуск завдань

### Автоматичні тригери

Завдання запускаються автоматично за розкладом (вираз cron).

### Ручні тригери

Адміністратори можуть запустити завдання негайно:

```bash
# Отримати ID завдання
docker exec task-tracker-api \
  psql -U postgres -d tasktracker -c \
  "SELECT id, func_ref FROM apscheduler_jobs WHERE func_ref LIKE '%automation%';"

# Запустити вручну
curl -X POST http://localhost/api/v1/automation/trigger
```

## Журнали виконання

### Де зберігаються журнали

```bash
# Docker логи (рекомендовано)
docker logs task-tracker-worker --follow

# Фільтр для автоматизації
docker logs task-tracker-worker | grep -i "automation\|schedule"
```

### Успішне виконання

```
2025-10-26 09:00:02 INFO Запущено виконання автоматизації
2025-10-26 09:00:02 INFO Оцінювання 47 незавершених версій
2025-10-26 09:00:03 INFO Правило 'High Confidence' відповідало 34 версіям
2025-10-26 09:00:04 INFO Авто-затверджено 34 версій
2025-10-26 09:00:05 INFO Виконання завершено (3.2s)
```

## Усунення помилок

| Помилка | Причина | Виправлення |
|---------|--------|-----------|
| Відмова підключення | PostgreSQL не в мережі | Перезапустіть postgres |
| Завдання не знайдено | Планувальник втратив завдання | Перезапустіть worker |
| Timeout (>30s) | Оцінювання правила занадто повільне | Оптимізуйте індекси БД |

### Кроки відновлення

```bash
# Визначити проблему
docker logs task-tracker-worker --tail=50

# Перезапустити worker
docker compose restart worker

# Контролювати відновлення
docker logs task-tracker-worker --follow
```

## Контрольний список усунення неполадок

**Завдання не запускається?**
- [ ] Worker служба запущена? (`docker ps`)
- [ ] Підключення до БД працює?
- [ ] Завдання запланодвано в БД?
- [ ] Вираз cron дійсний?
- [ ] Часовий пояс сервера правильний?

**Завдання виконується, але нічого не трапляється?**
- [ ] Журнал аудиту показує виконання?
- [ ] Умови правила спрацьовують?
- [ ] Транзакція бази даних коммітується?

---

**Пов'язане:** [Журнали аудиту](audit-logs.md) | [Продуктивність](performance-scaling.md)
