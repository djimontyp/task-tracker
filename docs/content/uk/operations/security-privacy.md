# Безпека та Приватність

**Останнє оновлення:** 26 жовтня 2025
**Статус:** Завершено - Фаза оцінки безпеки
**Рівень безпеки:** ПОМІРНИЙ

---

## Зміст

1. [Огляд безпеки](#огляд-безпеки)
2. [Аутентифікація та авторизація](#аутентифікація-та-авторизація)
3. [Безпека даних](#безпека-даних)
4. [Кращі практики безпеки](#кращі-практики-безпеки)
5. [Розгляд приватності](#розгляд-приватності)
6. [Рекомендації щодо безпеки](#рекомендації-щодо-безпеки)

---

## Огляд безпеки

Task Tracker впроваджує **помірні заходи безпеки**, сфокусовані на шифруванні ключів API, валідації вхідних даних та HTTP-заголовках безпеки. Система розроблена для **внутрішнього командного використання** в межах довірених мереж та покладається на мережевої безпеці з зворотним проксі Nginx.

!!! info "Поточний статус безпеки"
    - **Загальна оцінка:** ПОМІРНА
    - **Аутентифікація:** Не впроваджена (внутрішнє використання)
    - **Шифрування:** Ключі API (Fernet), Налаштування (AES-256-GCM)
    - **Передача:** Тільки HTTP (HTTPS шаблон надано)
    - **Валідація вхідних даних:** Сильна (моделі Pydantic)

### Сильні сторони безпеки

| Аспект | Статус | Деталі |
|--------|--------|--------|
| **Шифрування ключів API** | ✅ Сильне | Fernet симетричне шифрування (AES-128-CBC з HMAC) |
| **Валідація вхідних даних** | ✅ Сильна | Валідація моделей Pydantic + обмеження Fastapi |
| **Захист від SQL-ін'єкцій** | ✅ Сильний | SQLAlchemy ORM параметризовані запити |
| **HTTP-заголовки безпеки** | ✅ Впроваджено | CSP, X-Frame-Options, X-Content-Type-Options налаштовано |
| **Конфігурація CORS** | ✅ Настроюється | Обмежені походження, певні методи дозволено |

### Критичні прогалини

| Прогалина | Важкість | Вплив |
|-----------|----------|-------|
| **Відсутня аутентифікація користувача** | ВИСОКА | Усім споживачам API доступний повний доступ |
| **Відсутнє обмеження частоти запитів** | ВИСОКА | Вразливість до DoS-атак |
| **Тільки HTTP (розробка)** | ВИСОКА | Відсутнє шифрування TLS |
| **Відсутня політика зберігання даних** | ВИСОКА | Ризик відповідності приватності/GDPR |
| **Відсутня перевірка підпису webhook** | СЕРЕДНЯ | Telegram webhook вразлива до неавторизованих дзвінків |

---

## Аутентифікація та авторизація

### Поточний стан: Внутрішнє використання

Task Tracker розроблений для **внутрішнього командного використання** і не впроваджує систему аутентифікації користувачів. Усі кінцеві точки API доступні без облікових даних, покладаючись на мережеву безпеку.

!!! warning "Припущення дизайну"
    Ця система передбачає розгортання в межах надійної внутрішної мережі. Якщо розширити на зовнішніх користувачів, аутентифікація повинна бути впроваджена перед виробничим використанням.

### Модель доступу API

**Аутентифікація не потрібна** для кінцевих точок API тому що:
- Система розроблена для командного/внутрішнього використання
- Захист мережі через зворотний проксі Nginx
- Безпека маркерів бота Telegram контролюється Telegram
- Усі члени команди мають еквівалентні потреби доступу

### Безпека webhook Telegram

Кінцева точка webhook Telegram отримує повідомлення з інфраструктури Telegram:

**Поточна реалізація:**
- Покладається на **таємність маркера бота** для безпеки webhook
- Перевірка підпису webhook не впроваджена
- Мережевий захист через зворотний проксі Nginx

**Прогалина:** Кінцева точка webhook могла б отримувати неавторизовані запити, якби маркер бота виявився.

### Майбутні вимоги аутентифікації

Якщо система розширится на багатокористувацький чи зовнішній доступ:

| Компонент | Рекомендація | Пріоритет |
|-----------|--------------|----------|
| **Аутентифікація API** | Впровадити аутентифікацію ключа API + маркер | ВИСОКА |
| **Перевірка webhook** | Додати перевірку підпису Telegram | ВИСОКА |
| **Доступ на основі ролей** | Додати систему дозволів для мультитенанта | СЕРЕДНЯ |
| **Аутентифікація WebSocket** | Додати аутентифікацію на основі маркера для оновлень в реальному часі | СЕРЕДНЯ |

---

## Безпека даних

### Методи шифрування

Система використовує кілька підходів до шифрування для різних типів даних:

| Тип даних | Метод шифрування | Деталі | Управління ключами |
|-----------|-----------------|--------|-------------------|
| **Ключі API** | Fernet (AES-128-CBC + HMAC) | Симетричне шифрування перед збереженням | Один ключ у `.env` |
| **Дані налаштувань** | AES-256-GCM | Виведення ключа PBKDF2 (100k ітерацій) | `SETTINGS_ENCRYPTION_KEY` змінна оточення |
| **Повідомлення користувачів** | Немає | Зберігаються як простий текст у базі | Н/А |
| **PII користувачів** | Немає | Імена, електронні адреси, телефони зберігаються як простий текст | Н/А |

!!! tip "Статус шифрування"
    Чутливі облікові дані шифруються (ключі API, секрети постачальника). Повідомлення користувачів та PII **не шифруються в стані спокою**—залежно від ваших вимог приватності, розглядайте шифрування простого тексту даних у виробничих розгортаннях.

### Безпека бази даних

**Конфігурація PostgreSQL:**

| Аспект | Поточний стан | Рекомендація виробництва |
|--------|--------------|--------------------------|
| **Протокол з'єднання** | Без шифрування TLS | Увімкніть SSL для PostgreSQL на виробництво |
| **Силу пароля** | Пароль за замовчуванням (`postgres`) | Використовуйте сильні, унікальні паролі |
| **Розкриття мережі** | Порт 5555 розкритий на хості | Використовуйте тільки внутрішню мережу Docker |
| **Шифрування в стані спокою** | Не налаштовано | Увімкніть шифрування на рівні диска |
| **Рядок з'єднання** | Простий текст у середовищі | Використовуйте систему управління секретами |

**Налаштування розробки:**
```
postgresql+asyncpg://postgres:postgres@postgres:5432/tasktracker
```

### Конфігурація TLS/HTTPS

**Режим розробки:**
- Тільки HTTP (порт 80)
- Без HTTPS (спрощено для локальної розробки)
- Заголовки безпеки налаштовано, але HSTS вимкнено

**Шаблон виробництва:**
- Блок HTTPS надано в nginx.conf (зараз закоментовано)
- TLS 1.2+ налаштовано з сильними шифрами
- HSTS-заголовок готовий до виробництва
- Потребує SSL-сертифікатів (Let's Encrypt рекомендується)

!!! danger "Критично для виробництва"
    HTTPS повинен бути увімкнений для виробничих розгортань. HTTP передає всі дані як простий текст, розкриваючи облікові дані та повідомлення користувачів для перехоплення мережею.

### Управління секретами

**Поточний підхід:**
- Секрети зберігаються у файлі `.env` (в .gitignore)
- Передаються контейнерам через Docker Compose `env_file`
- Відсутня система автоматизованого управління секретами

**Чутливі змінні:**
- `TELEGRAM_BOT_TOKEN` - Аутентифікація бота
- `ENCRYPTION_KEY` - Шифрування ключів API
- `SETTINGS_ENCRYPTION_KEY` - Шифрування налаштувань
- `POSTGRES_PASSWORD` - Аутентифікація бази даних

**Прогалини:**
- ❌ Відсутній механізм ротації ключів
- ❌ Відсутня система управління секретами (Vault, AWS Secrets Manager)
- ❌ Один ключ шифрування для всіх ключів API
- ✅ Секрети не завантажуються у git

---

## Кращі практики безпеки

### Валідація вхідних даних ✅

**Моделі Pydantic** забезпечують суворої валідації на всіх вхідних даних:

| Метод валідації | Покриття | Приклади |
|-----------------|----------|----------|
| **Type Hints** | Усі кінцеві точки | Автоматична валідація Fastapi від type hints |
| **Власні валідатори** | Окремі поля | Формат номера телефону, валідація електронної пошти |
| **Обмеження запиту** | Параметри API | `limit` 1-1000, `skip` >= 0 |
| **Обмеження рядків** | Текстові поля | Мін./макс. довжина, regex-патерни |

**Результат:** SQL-ін'єкції та атаки з неправильно сформованими вхідними даними запобігаються через параметризовані запити та типи безпеки.

### Захист від XSS ✅

**HTTP-заголовки безпеки:**

| Заголовок | Конфігурація | Мета |
|-----------|-------------|------|
| **CSP** | Обмежує джерела скрипту, дозволяє unsafe-inline для розробки | Запобігає вбудованому введенню скриптів |
| **X-Frame-Options** | SAMEORIGIN | Запобігає атакам кліцтрейсингу |
| **X-Content-Type-Options** | nosniff | Запобігає пошуку типу MIME |
| **X-XSS-Protection** | 1; mode=block | Legacy XSS-фільтр (браузери) |
| **Referrer-Policy** | strict-origin-when-cross-origin | Обмежує витік рефереру |

**Розгляд виробництва:** CSP дозволяє `'unsafe-inline'` та `'unsafe-eval'` для режиму розробки Vite. Вони повинні бути видалені у виробничих збірках.

### Конфігурація CORS ✅

| Аспект | Статус | Конфігурація |
|--------|--------|-------------|
| **Походження** | Настроюється | `CORS_ORIGINS` змінна оточення (не підстановка) |
| **Методи** | Обмежено | GET, POST, PUT, DELETE, OPTIONS тільки |
| **Заголовки** | Конкретні | Content-Type, Authorization, X-Request-ID |
| **Облікові дані** | Дозволено | `allow_credentials=true` (безпечно з обмеженими походженнями) |

**Безпека:** Походження настроюється, дозволяючи різні значення для розробки та виробництва без змін коду.

### Обмеження частоти запитів ❌

**Поточний статус:** Не впроваджено

| Тип кінцевої точки | Поточний захист | Вразливість |
|-------------------|-----------------|-----------|
| **Публічний API** | Немає | Вразливість до DoS-атак |
| **Webhook** | Немає | Можна зловживати спам-ботами |
| **WebSocket** | Немає | Без обмежень з'єднань |

**Ризик:** Зловмисники можуть перевантажити систему великою кількістю запитів.

### Обробка помилок

**Поточний підхід:**
- Послідовні коди стану HTTP (400, 404, 409, 502, 504)
- Осмислені повідомлення про помилки
- Загальна обробка помилок запобігає краху

**Прогалина:** Повідомлення про помилки можуть розкривати внутрішні деталі (спеціфіка помилок бази даних). У виробництві здійснюйте дезинфекцію помилок, щоб уникнути розкриття інформації.

---

## Розгляд приватності

### Зібрані дані

Система збирає та зберігає такі дані користувачів та повідомлень:

| Тип даних | Зібрано | Зберіганий місце | Зберігання |
|-----------|---------|-----------------|----------|
| **Повідомлення Telegram** | ✅ Так | `message` таблиця простий текст | Невизначено |
| **Імена користувачів** | ✅ Так | `user` таблиця простий текст | Невизначено |
| **Електронні адреси** | ✅ Так | `user` таблиця простий текст | Невизначено |
| **Номери телефонів** | ✅ Так | `user` таблиця простий текст | Невизначено |
| **Вбудовування повідомлень** | ✅ Так | `message` таблиця (вектори) | Невизначено |
| **Інформація профілю Telegram** | ✅ Так | `telegram_profile` таблиця | Невизначено |
| **Часові мітки повідомлень** | ✅ Так | `message` таблиця | Невизначено |
| **URL-адреси аватара** | ✅ Так | `user`, `telegram_profile` | Невизначено |

### Поточні прогалини в приватності

| Прогалина | Важкість | Опис |
|-----------|----------|------|
| **Відсутня політика зберігання даних** | КРИТИЧНА | Повідомлення зберігаються невизначено без механізму очищення |
| **Відсутнє шифрування в стані спокою** | ВИСОКА | PII користувача зберігається як простий текст у базі |
| **Відсутня реєстрація згоди користувача** | ВИСОКА | Без механізму для підтвердження приймання користувачем збору даних |
| **Відсутня API експорту даних** | ВИСОКА | Користувачі не можуть отримати свої дані (порушення GDPR) |
| **Відсутня API видалення даних** | ВИСОКА | Користувачі не можуть видалити свої дані (порушення GDPR) |
| **Відсутня політика приватності** | ВИСОКА | Користувачі не інформуються про методи обробки даних |
| **Відсутня відповідність GDPR** | КРИТИЧНА | Відсутні ключові функції для закону про захист даних ЄС |

### Статус відповідності GDPR

Якщо система обслуговує користувачів ЄС, ці вимоги **не виконуються**:

| Вимога GDPR | Статус | Проблема |
|------------|--------|---------|
| **Право на доступ** | ❌ Відсутнє | Відсутня API експорту даних користувача |
| **Право на видалення** | ❌ Відсутнє | Відсутня API видалення користувача |
| **Право на виправлення** | ✅ Часткове | Кінцеві точки оновлення існують, але не призначені користувачу |
| **Право на портативність даних** | ❌ Відсутнє | Немає формату експорту (JSON) |
| **Мінімізація даних** | ⚠️ Часткова | Зібрано тільки необхідні дані, але без очищення |
| **Обмеження зберігання** | ❌ Відсутнє | Відсутня політика утримання або автоматичне видалення |
| **Управління згодою** | ❌ Відсутнє | Відсутня реєстрація згоди або механізм вибору |
| **Приватність за дизайном** | ⚠️ Часткова | Деяке шифрування, але багато прогалин |

!!! danger "Для розгортань ЄС"
    Якщо служить користувачам ЄС, ці прогалини GDPR повинні бути усунені перед виробничим розгортанням. Порушення можуть призвести до значних штрафів.

### Кращі практики приватності

**Рекомендації для розгортання:**

1. **Створити політику приватності** - Документуйте, які дані збираються та як вони використовуються
2. **Впровадити зберігання даних** - Визначте тривалість життя повідомлення (рекомендація: 90 днів для чутливих систем)
3. **Додати видалення користувача** - Дозвольте користувачам видаляти свої дані на вимогу
4. **Шифрування чутливих даних** - Розглядайте шифрування імен, электронних адрес, номерів телефонів
5. **Мінімізація збору** - Збирайте тільки дані, необхідні для функціонування системи
6. **Документування обробки** - Створіть угоду про обробку даних (DPA) для вашої організації

---

## Рекомендації щодо безпеки

### Пріоритетні елементи дій

#### 🔴 КРИТИЧНО (Впроваджуйте одразу)

| Рекомендація | Зусилля | Вплив | Обґрунтування |
|--------------|---------|-------|--------------|
| **Увімкніть HTTPS на виробництво** | Низькі | ВИСОКА | Шифрує всі дані при передачі; потрібна для чутливої інформації |
| **Впровадити обмеження частоти запитів** | Середні | ВИСОКА | Запобігає DoS-атакам на публічні кінцеві точки та webhook |
| **Визначити політику зберігання даних** | Низькі | ВИСОКА | Зменшує ризик приватності/GDPR; документує життєвий цикл даних |
| **Додати сканування залежностей** | Низькі | ВИСОКА | Виявляє вразливі пакети; інтегрується в CI/CD |

**Чому терміново:**
- HTTPS запобігає перехопленню облікових даних/повідомлень
- Обмеження частоти запитів зупиняє прості DoS-атаки
- Політика зберігання вирішує юридичну відповідність
- Сканування залежностей виявляє відомі вразливості рано

#### 🟠 ВИСОКА (Впроваджуйте перед виробництвом)

| Рекомендація | Зусилля | Вплив | Обґрунтування |
|--------------|---------|-------|--------------|
| **Перевірка підпису webhook** | Середні | ВИСОКА | Запобігає неавторизованим запитам webhook; валідує автентичність Telegram |
| **Сильні паролі для бази даних** | Низькі | СЕРЕДНЯ | Пароль за замовчуванням відомий; легко зломано |
| **Увімкніть SSL для PostgreSQL** | Середні | СЕРЕДНЯ | Шифрує з'єднання бази даних; потрібна для виробництва |
| **Видаліть розкриття порту** | Низькі | СЕРЕДНЯ | Postgres розкритий на порту хосту; повинен використовувати тільки внутрішню мережу |

**Обсяг впровадження:**
- Додайте перевірку заголовка `X-Telegram-Bot-API-Secret-Token`
- Генеруйте сильний пароль бази даних (20+ символів, випадковий)
- Увімкніть SSL на контейнері бази даних
- Оновіть docker-compose для використання внутрішньої мережі

#### 🟡 СЕРЕДНЯ (Впроваджуйте на етапі 2)

| Рекомендація | Зусилля | Вплив | Обґрунтування |
|--------------|---------|-------|--------------|
| **Затягніть CSP-заголовки** | Низькі | СЕРЕДНЯ | Виробничої збірка: видаліть `'unsafe-inline'` та `'unsafe-eval'` |
| **API експорту даних користувача** | Середні | ВИСОКА | GDPR право на доступ; потрібна для розгортань ЄС |
| **API видалення даних користувача** | Середні | ВИСОКА | GDPR право на стирання; потрібна для розгортань ЄС |
| **Безпека контейнерів** | Середні | СЕРЕДНЯ | Запускайте як не-root; сканяйте з Trivy; багатоетапні збірки |

**Фокус GDPR:**
- Кінцева точка експорту: `/api/users/{user_id}/export` повертає JSON
- Кінцева точка видалення: `/api/users/{user_id}/delete` з підтвердженням
- Автоматична очистка: фонова задача видалення повідомлень після періоду утримання

#### 🟢 НИЗЬКА (Розглядайте для етапу 3+)

| Рекомендація | Зусилля | Вплив | Обґрунтування |
|--------------|---------|-------|--------------|
| **Система управління секретами** | Висока | СЕРЕДНЯ | Vault/AWS Secrets Manager; ротація ключів; аудит реєстрування |
| **Аутентифікація WebSocket** | Середні | НИЗЬКА | Чутливі приборні панелі; запобігає неавторизованим з'єднанням |
| **Аудит реєстрування** | Середні | СЕРЕДНЯ | Реєстрування подій безпеки; вимога відповідності |
| **Автоматизований патч** | Середні | СЕРЕДНЯ | Оновлення залежностей; запланований випуск безпеки |

---

## Контрольний список безпеки

Використовуйте цей контрольний список для тестування безпеки та валідації:

!!! note "Попередня валідація безпеки виробництва"

    - [ ] Увімкніть HTTPS з дійсним SSL-сертифікатом
    - [ ] Тестуйте обмеження частоти запитів під навантаженням (ціль: 100+ req/sec)
    - [ ] Перевірте дійсність та надійність HTTPS-сертифіката
    - [ ] Тестуйте перевірку підпису webhook з неправильними маркерами
    - [ ] Тестуйте CORS з неавторизованим походженням (повинно провалитися)
    - [ ] Спробуйте SQL-ін'єкцію на всіх кінцевих точках (повинно провалитися)
    - [ ] Тестуйте XSS з зловмісними корисними навантаженнями (повинно бути екранізовано/заблоковано)
    - [ ] Перевірте цілісність шифрування/дешифрування ключа API
    - [ ] Нагрузіть тест фонду з'єднання бази даних
    - [ ] Перевірте завершеність робочих процесів видалення даних
    - [ ] Підтвердіть, що CSP-заголовки відповідають вимогам виробничої збірки
    - [ ] Тестуйте обробку помилок (не повинна розкривати трасування стека)
    - [ ] Перевірте, що секрети не розкриваються в журналах
    - [ ] Сканіруйте залежності за допомогою інструментів безпеки/Snyk
    - [ ] Тестуйте обмеження з'єднання WebSocket (якщо впроваджено)

---

## Пов'язана документація

- **Операції → Розгортання** - Налаштування виробничого середовища з HTTPS, секретами, мережею
- **Операції → Конфігурація** - Змінні оточення, шифрування налаштувань, управління секретами
- **Архітектура → Огляд системи** - Повна архітектура системи та потік даних
- **API → Знання** - Документація кінцевої точки API та приклади запиту/відповіді

---

!!! success "Підхід, орієнтований на безпеку"
    Task Tracker впроваджує фундаментальну безпеку з шифруванням ключів API, валідацією вхідних даних та HTTP-заголовками безпеки. Вирішення критичних та високопріоритетних рекомендацій значно покращить стан безпеки для виробничих розгортань.
