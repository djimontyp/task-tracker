default:
    @just --list

# Aliases
alias ss := services
alias st := services-stop
alias sc := services-clean
alias sca := services-clean-all
alias dbc := db-clear
alias dbs := db-seed
alias dbr := db-reset
alias dbtc := db-topics-clear
alias dbts := db-topics-seed
alias dbtr := db-topics-reset
alias dbac := db-analysis-clear
alias dbas := db-analysis-seed
alias dbar := db-analysis-reset
alias dbfs := db-full-seed
alias dbfr := db-full-reset
alias dbnr := db-nuclear-reset
alias dbmf := db-migrate-fresh
alias f := fmt
alias fc := fmt-check
alias tc := typecheck
alias tcs := typecheck-strict

SERVICES := "postgres nats worker api dashboard nginx"

# Reinstall UV venv and all dependencies locally
[group: 'Development']
rds:
    rm -rf .venv
    uv venv --python 3.13
    uv sync --all-groups

# Install dependencies
[group: 'Development']
install-dev:
    @echo "Installing dependencies..."
    uv sync --all-groups

# Upgrade dependencies
[group: 'Development']
upgrade:
    @echo "Updating dependencies..."
    uv lock --upgrade --all-groups

# Start services (production mode)
[group: 'Services']
services:
    @echo "Starting services (postgres nats worker api dashboard nginx)..."
    docker compose up -d postgres nats worker api dashboard nginx
    @echo "Services started."
    @echo "üåê Available at: http://localhost"
    @echo "üì± Telegram WebApp: http://localhost/webapp"
    @echo "üìä Dashboard: http://localhost/dashboard"
    @echo "üîó Webhook URL: http://localhost/webhook/telegram"

# Start services in development mode with watch
[group: 'Services']
services-dev:
    @echo "Starting services in development mode with file watching..."
    docker compose watch
    @echo "Restarting nginx to refresh connections..."
    docker restart task-tracker-nginx || true

# Start specific service in development mode
[group: 'Services']
dev SERVICE:
    @echo "Starting {{SERVICE}} in development mode..."
    docker compose watch {{SERVICE}}

# Rebuild specific service
[group: 'Services']
rebuild SERVICE:
    @echo "Rebuilding {{SERVICE}}..."
    COMPOSE_BAKE=true docker compose build {{SERVICE}} --no-cache
    docker compose up -d {{SERVICE}}

# Stop services
[group: 'Services']
services-stop:
    @echo "Stopping services..."
    docker compose down postgres nats worker api dashboard nginx
    @echo "Services stopped."

# Full clean services without volumes
[group: 'Services']
services-clean:
    @echo "Stopping and removing services containers..."
    docker compose down
    @echo "Services containers removed."

# Full clean services with images removal
[group: 'Services']
services-clean-all:
    @echo "Stopping and removing services containers and images..."
    docker compose down --rmi all
    @echo "Services containers and images removed."

# Run Alembic migrations
[group: 'Database']
alembic-up:
    @echo "Applying database migrations..."
    uv run alembic upgrade head

# Create alembic autogenerated migration
[group: 'Database']
alembic-auto *ARGS:
    @echo "Creating database migration..."
    uv run alembic revision --autogenerate {{ARGS}}

# Complete database reset (stop services, clean volumes, restart postgres, run migrations)
[group: 'Database']
db-nuclear-reset:
    @echo "üí£ Nuclear database reset initiated..."
    @just services-stop
    @echo "üóëÔ∏è  Removing database volumes..."
    @docker compose down -v
    @echo "üêò Starting postgres..."
    @docker compose up -d postgres
    @echo "‚è≥ Waiting for postgres to be ready..."
    @sleep 5
    @docker compose exec postgres pg_isready -U postgres -d tasktracker || sleep 3
    @echo "üîÑ Running migrations..."
    @just alembic-up
    @echo "‚úÖ Database reset complete! Clean slate ready."

# Fresh migration (ensure postgres is running and apply migrations)
[group: 'Database']
db-migrate-fresh:
    @echo "üîÑ Applying fresh migrations..."
    @docker compose up -d postgres
    @echo "‚è≥ Waiting for postgres to be ready..."
    @sleep 3
    @docker compose exec postgres pg_isready -U postgres -d tasktracker || sleep 2
    @just alembic-up
    @echo "‚úÖ Migrations applied successfully!"

# Format code: organize imports + format style
[group: 'Quality']
fmt PATH='backend':
    @echo "üé® Formatting {{PATH}}..."
    @uv run ruff check {{PATH}} --select I,F401,UP --fix --unsafe-fixes --show-fixes
    @uv run ruff format {{PATH}}
    @echo "‚ú® Format complete!"

# Check formatting without changes (CI)
[group: 'Quality']
fmt-check PATH='backend':
    @echo "üîç Checking format on {{PATH}}..."
    @uv run ruff check {{PATH}} --select I,F401,UP
    @uv run ruff format {{PATH}} --check
    @echo "‚úÖ Format check passed!"

# Run mypy type checking
[group: 'Quality']
typecheck PATH='.':
    @echo "üîé Running mypy type checking on {{PATH}}..."
    @cd backend && uv run mypy {{PATH}}
    @echo "‚úÖ Type check passed!"

# Run strict mypy type checking (show all errors)
[group: 'Quality']
typecheck-strict PATH='.':
    @echo "üî¨ Running strict mypy type checking on {{PATH}}..."
    @cd backend && uv run mypy {{PATH}} --strict --show-error-context
    @echo "‚úÖ Strict type check passed!"

# Serve MkDocs documentation locally with live reload
[group: 'Documentation']
docs:
    @echo "Serving documentation with live reload..."
    uv run --group docs mkdocs serve --config-file docs/mkdocs.yml --dev-addr 127.0.0.1:8081 --livereload

# Clear all test data from database
[group: 'Database']
db-clear:
    @echo "Clearing database..."
    uv run python scripts/seed_db.py --clear

# Seed test data into database
[group: 'Database']
db-seed COUNT="50":
    @echo "Seeding {{COUNT}} tasks..."
    uv run python scripts/seed_db.py --seed --count {{COUNT}}

# Clear and seed database (fresh start)
[group: 'Database']
db-reset COUNT="50":
    @echo "Resetting database with {{COUNT}} tasks..."
    uv run python scripts/seed_db.py --clear --seed --count {{COUNT}}

# Clear topics, atoms, messages and relationships
[group: 'Database']
db-topics-clear:
    @echo "Clearing topics, atoms, and messages..."
    cd backend && uv run python scripts/seed_topics_atoms.py --clear

# Seed topics, atoms, messages and relationships
[group: 'Database']
db-topics-seed TOPICS="5" ATOMS="10" MESSAGES="20":
    @echo "Seeding {{TOPICS}} topics with {{ATOMS}} atoms and {{MESSAGES}} messages each..."
    cd backend && uv run python scripts/seed_topics_atoms.py --seed --topics {{TOPICS}} --atoms {{ATOMS}} --messages {{MESSAGES}}

# Clear and seed topics/atoms (fresh start)
[group: 'Database']
db-topics-reset TOPICS="5" ATOMS="10" MESSAGES="20":
    @echo "Resetting topics with {{TOPICS}} topics, {{ATOMS}} atoms, {{MESSAGES}} messages..."
    cd backend && uv run python scripts/seed_topics_atoms.py --clear --seed --topics {{TOPICS}} --atoms {{ATOMS}} --messages {{MESSAGES}}

# Seed topics, atoms, and messages for testing
[group: 'Database']
seed-topics COUNT="5":
    @echo "Seeding {{COUNT}} topics with atoms and messages..."
    uv run python scripts/seed_topics_atoms.py --seed --topics {{COUNT}}

# Clear all topics, atoms, and messages
[group: 'Database']
clear-topics:
    @echo "Clearing topics, atoms, and messages..."
    uv run python scripts/seed_topics_atoms.py --clear

# Reset topics data (clear + seed)
[group: 'Database']
reset-topics COUNT="5":
    @echo "Resetting topics data..."
    uv run python scripts/seed_topics_atoms.py --clear --seed --topics {{COUNT}}

# Clear Analysis System data (providers, agents, tasks, runs, proposals)
[group: 'Database']
db-analysis-clear:
    @echo "Clearing Analysis System data..."
    cd backend && uv run python scripts/seed_analysis_system.py --clear

# Seed Analysis System data
[group: 'Database']
db-analysis-seed RUNS="10" PROPOSALS="30":
    @echo "Seeding Analysis System: {{RUNS}} runs, {{PROPOSALS}} proposals..."
    cd backend && uv run python scripts/seed_analysis_system.py --seed --runs {{RUNS}} --proposals {{PROPOSALS}}

# Clear and seed Analysis System (fresh start)
[group: 'Database']
db-analysis-reset RUNS="10" PROPOSALS="30":
    @echo "Resetting Analysis System with {{RUNS}} runs, {{PROPOSALS}} proposals..."
    cd backend && uv run python scripts/seed_analysis_system.py --clear --seed --runs {{RUNS}} --proposals {{PROPOSALS}}

# Seed EVERYTHING: tasks + topics + analysis system
[group: 'Database']
db-full-seed:
    @echo "üå± Full database seeding..."
    @just db-seed 50
    @just db-topics-seed 5 10 20
    @just db-analysis-seed 10 30
    @echo "‚úÖ Complete database populated!"

# Clear and seed EVERYTHING (nuclear reset)
[group: 'Database']
db-full-reset:
    @echo "üóëÔ∏è  Nuclear database reset..."
    @just db-clear
    @just db-topics-clear
    @just db-analysis-clear
    @echo "üå± Reseeding everything..."
    @just db-seed 50
    @just db-topics-seed 5 10 20
    @just db-analysis-seed 10 30
    @echo "‚úÖ Complete database reset finished!"

# Run tests
[group: 'Testing']
test:
    @echo "Running tests..."
    uv run python -m pytest

# Run API tests for atoms
[group: 'Testing']
test-atoms:
    @echo "Running atoms API tests..."
    uv run pytest tests/api/test_atoms.py -v

# Run all tests with coverage
[group: 'Testing']
test-all:
    @echo "Running all tests with coverage..."
    uv run pytest --cov=app --cov-report=term-missing
