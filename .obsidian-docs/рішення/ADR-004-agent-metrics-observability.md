# ADR-004: Agent Metrics & Observability Strategy

**Status:** Accepted
**Date:** 2026-01-09
**Context:** Agent Dashboard UX Redesign ("Control Unit")

## Контекст
Ми розробляємо "Control Unit" для AI-агентів. Користувачу (інженеру) необхідно бачити стан системи.
Початковий запит включав бажання бачити **Cost ($)** та **Token Usage** на картках агентів.
Технічний аналіз показав:
1.  Pydantic AI надає дані про використання токенів (`result.usage()`), але ми їх наразі не зберігаємо.
2.  Модель `LLMProvider` не містить тарифних планів (pricing strategy), тому конвертація токенів у гроші вимагає хардкоду або нової підсистеми білінгу.
3.  Існують спеціалізовані інструменти для LLM Observability (Logfire, LangSmith), які вирішують цю задачу професійно.

## Рішення

1.  **Прийняти стратегію "Vital Signs" (Життєві Показники) для UI:**
    Замість фінансової звітності, ми фокусуємось на операційній спроможності агента. На картку виводяться метрики, доступні з існуючої історії запусків:
    *   **Last Active** (Recency): Час останнього запуску. *(Чи він живий?)*
    *   **Success Rate** (Reliability): % успішних виконання. *(Чи він здоровий?)*
    *   **Avg Duration** (Performance): Середній час виконання. *(Чи він не тупить?)*
    *   **24h Load** (Volume): Кількість запусків за добу. *(Чи він працює?)*

2.  **Відкласти кастомний білінг (Cost & Tokens):**
    Ми свідомо відмовляємось від реалізації ручного підрахунку вартості та токенів у Phase 1. Це додає зайву складність (maintenance cost) і дублює функціонал існуючих платформ.

3.  **Future Path: Native Observability:**
    Для детальної аналітики (Cost, Traces, Debugging) у майбутньому буде інтегровано **Logfire** (рідний інструмент Pydantic AI) або аналог. UI Pulse Radar буде відображати лише високорівневі метрики "здоров'я".

## Наслідки

### Позитивні
*   **Швидкість:** Ми можемо реалізувати метрики вже зараз без змін у схемі БД (крім агрегації).
*   **UX:** Інтерфейс залишається чистим і сфокусованим на стабільності системи, а не на бухгалтерії.
*   **Simplicity:** Уникаємо написання власної логіки тарифікації, яка швидко застаріває (зміни цін OpenAI/Anthropic).

### Негативні
*   Користувач не бачить, скільки грошей "з'їв" агент прямо в дешборді (поки не підключимо Logfire).
*   Відсутність видимості usage limits (але це вирішується на рівні конфігу).

## Технічна реалізація (Phase 1)
*   **Джерело даних:** Таблиця `knowledge_extraction_run`.
*   **API:** `GET /agents/{id}/stats` (обчислюється динамічно або кешується).
*   **Frontend:** Компонент `AgentCard` оновлюється для відображення Vital Signs.
