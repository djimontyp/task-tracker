---
type: journal
date: 2025-12-29
tags:
  - typescript
  - bugfix
  - frontend
---

# 2025-12-29

## Session: TypeScript Type Fixes

### Completed

**Phase 2: Source-Agnostic Batching** (from previous session)
- Message Model: +4 fields (source_channel_id, source_thread_id, source_parent_id, detected_language)
- Migration: `f3a1c52d26a6`
- batching_service.py: thread grouping + time-gap
- Tests: 12 passed

**Extraction Testing**
- 244 messages from real chat
- 12 groups after batching (10 min time-gap)
- Created: 3 topics + 6 atoms + 3 links
- Script: `backend/scripts/test_extraction_messages.py`

**Critical Fixes (today)**

| Issue | Status | Details |
|-------|--------|---------|
| WebSocket Connection Leak | Fixed | Removed useWebSocket from AtomCard |
| API URLs 404 | Fixed | `/api/v1/versions/atoms/` → `/api/v1/atoms/` |
| Atom.id type mismatch | Fixed | `number` → `string` (UUID) |

**Files changed:**
- `features/atoms/types/index.ts` — `Atom.id: string`
- `features/atoms/api/atomService.ts` — all methods
- `features/knowledge/components/VersionDiffViewer.tsx`
- `features/knowledge/components/VersionHistoryList.tsx`
- `features/atoms/components/AtomCard.stories.tsx` — mock UUIDs
- `pages/VersionsPage/index.tsx`

**Result:** `npx tsc --noEmit` — 0 errors

### N+1 Fix — DONE

**Problem:** Each AtomCard made HTTP request for pending versions count.

**Solution:** Added `pending_versions_count` to Atom API response (LEFT JOIN).

| Layer | Change |
|-------|--------|
| Backend model | `AtomPublic.pending_versions_count: int` |
| Backend CRUD | `list_atoms`, `get_atom`, `list_by_topic` — subquery + LEFT JOIN |
| Frontend type | `Atom.pending_versions_count: number` |
| Frontend component | AtomCard uses prop instead of HTTP call |

**Result:** 1 request instead of N+1.

### TODO (Future)

**Performance:**
- [x] N+1 queries on versions — ~~batch endpoint~~ included in Atom response
- [x] Web Vitals metrics (LCP, FID, CLS) — **DONE**
- [x] Lighthouse CI in pipeline — **DONE**

**API Contracts:**
- [ ] `just api-sync` — verify Atom.id in OpenAPI schema

---

## Session: Web Vitals + Lighthouse CI

**03:10** — Performance monitoring implementation

### Completed

| Component | Details |
|-----------|---------|
| `web-vitals` package | Installed, tracking LCP, INP, CLS, FCP, TTFB |
| Feature module | `features/performance/` — types, hooks, components |
| Dashboard UI | `/performance` route with cards + chart |
| Lighthouse CI | `.github/workflows/lighthouse.yml` + `lighthouserc.js` |

**Files created:**
```
frontend/src/features/performance/
├── types/index.ts
├── utils/thresholds.ts
├── hooks/useWebVitals.ts
├── components/
│   ├── VitalsStatusBadge.tsx
│   ├── WebVitalsCards.tsx
│   ├── WebVitalsChart.tsx
│   └── PerformanceDashboard.tsx
└── index.ts

frontend/lighthouserc.js
.github/workflows/lighthouse.yml
frontend/src/pages/PerformancePage/index.tsx
```

**Integration:**
- `providers.tsx` — Web Vitals init at app startup
- `routes.tsx` — `/performance` route
- `AppSidebar` — "МОНІТОРИНГ" → "Продуктивність"
- Translations: UK + EN

**Performance Budgets (Lighthouse):**
- LCP < 2500ms
- CLS < 0.1
- Performance score >= 80%
- Accessibility score >= 90%

### Notes

- Web Vitals моніторить page load, не SPA navigation
- Метрики зберігаються в localStorage (останні 100)
- В dev mode логи в консоль `[DEBUG] [WebVitals]`

## Related

- [[entity-hierarchy]] — updated with UUID types
- [[typescript-конфіг]] — strict mode active
