# Data Model: Telegram Integration UI

**Feature**: 004-telegram-integration-ui
**Date**: 2025-12-13
**Status**: Minimal changes - leverages existing models

## Overview

This feature is **frontend-only** and uses existing backend data models without modifications.

## Existing Entities (No Changes)

### TelegramWebhookConfig (Backend Schema)

```python
# backend/app/schemas/__init__.py
class TelegramWebhookConfig(BaseModel):
    protocol: Literal["http", "https"] = "https"
    host: str
    webhook_url: str | None = None
    is_active: bool = False
    last_set_at: datetime | None = None
    groups: list[TelegramGroupInfo] = []
```

**Frontend TypeScript** (generated by orval):
```typescript
// frontend/src/shared/api/model/telegramWebhookConfig.ts
interface TelegramWebhookConfig {
  protocol: 'http' | 'https'
  host: string
  webhook_url?: string | null
  is_active: boolean
  last_set_at?: string | null
  groups: TelegramGroupInfo[]
}
```

### TelegramGroupInfo (Backend Schema)

```python
class TelegramGroupInfo(BaseModel):
    id: int
    name: str | None = None
```

**Frontend TypeScript**:
```typescript
interface TelegramGroupInfo {
  id: number
  name?: string | null
}
```

### WebhookConfigResponse (Backend Schema)

```python
class WebhookConfigResponse(BaseModel):
    telegram: TelegramWebhookConfig | None = None
    default_protocol: str
    default_host: str
```

## New Frontend Types (UI Only)

### SetupStep (Local State)

```typescript
// frontend/src/pages/SettingsPage/plugins/TelegramSource/types.ts

type SetupStepId = 'bot-info' | 'webhook' | 'verify'

interface SetupStep {
  id: SetupStepId
  title: string
  description: string
  isComplete: boolean
}

const SETUP_STEPS: SetupStep[] = [
  {
    id: 'bot-info',
    title: 'Bot Info',
    description: 'Learn about our Telegram bot',
    isComplete: false,
  },
  {
    id: 'webhook',
    title: 'Configure Webhook',
    description: 'Set up your webhook URL',
    isComplete: false,
  },
  {
    id: 'verify',
    title: 'Verify Connection',
    description: 'Test the integration',
    isComplete: false,
  },
]
```

### WizardState (Component State)

```typescript
interface WizardState {
  currentStep: SetupStepId
  stepsCompleted: Set<SetupStepId>
  isFirstTimeSetup: boolean  // determined by isActive === false
}
```

## State Flow

```
┌─────────────────────────────────────────────────────────────────┐
│  Initial Load                                                    │
│                                                                  │
│  GET /api/v1/webhook-settings                                   │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────────┐                                            │
│  │ isActive: false │ ──────▶ Show Wizard (Step 1: Bot Info)    │
│  └─────────────────┘                                            │
│         │                                                        │
│         ▼                                                        │
│  ┌─────────────────┐                                            │
│  │ isActive: true  │ ──────▶ Show Status Card (connected)       │
│  └─────────────────┘                                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Validation Rules

### Frontend Validation (New)

| Field | Rule | Error Message |
|-------|------|---------------|
| `host` | Required, non-empty | "Host is required" |
| `host` | No protocol prefix | "Enter host without http://" |
| `protocol` | Must be 'https' (production) | "HTTPS required for production" |

### Backend Validation (Existing)

| Endpoint | Validation | Status Code |
|----------|------------|-------------|
| `POST /webhook-settings` | host must not be empty | 400 |
| `POST /webhook-settings` | host must not include protocol | 400 |
| `POST /telegram/set` | Same as above | 400 |

## Entity Relationships

```
┌────────────────────────┐
│   WebhookSettings      │  (Database table)
│   name: string         │
│   config: JSON         │──────┐
│   is_active: bool      │      │
└────────────────────────┘      │
                                │
                                ▼
                   ┌────────────────────────┐
                   │ config.telegram = {    │  (JSON structure)
                   │   protocol: string     │
                   │   host: string         │
                   │   webhook_url: string  │
                   │   is_active: bool      │
                   │   last_set_at: datetime│
                   │   groups: [            │
                   │     { id, name }       │
                   │   ]                    │
                   │ }                      │
                   └────────────────────────┘
```

## No Database Migrations Required

This feature does not require any database schema changes. All data structures are already in place:

- ✅ `WebhookSettings` table exists
- ✅ `TelegramWebhookConfig` schema exists
- ✅ Groups storage in JSON config exists
- ✅ All API endpoints exist

## Frontend State Management

No new Zustand store required. State is managed locally in:

1. `useTelegramSettings` hook - API state, form values
2. Component local state - wizard step navigation
3. localStorage - webhook base URL cache (existing)
